---
sidebar_position: 4
sidebar_label: Выравнивание
---

# Выравнивание

После успешного выполнения
стадии ["Проверка качества и очистка"](/results/workflow-details/fastq-analysis/check-quality-and-cleanup)
для дальнейшего выявления вариации числа копий необходимо выполнить выравнивание (картирование) прочтений на
референсный геном. Для выравнивания используется наиболее современная версия генома
человека - [GRCh38.p14](https://www.ncbi.nlm.nih.gov/datasets/genome/GCF_000001405.40/).
Если выравнивание [исключено из анализа](/settings/settings/alignment-settings#disable-alignment),
то после успешного выполнения
стадий ["Загрузка, идентификация и проверка"](/results/workflow-details/fastq-analysis/upload-identify-verify)
и ["Проверка качества и очистка"](/results/workflow-details/fastq-analysis/check-quality-and-cleanup) анализ
завершается.
При ошибке выполнения любой из перечисленных ниже задач анализ образца останавливается.

<p align="center">
<img src={require('/img/rus/alignment.png').default} width="650"/>
</p>

Стадия анализа образца "Выравнивание" может включать следующие задачи:
1. **Проверка и восстановление парности прочтений** запускается, если выполняются следующие условия:
   - Анализируется образец парного секвенирования (секвенирование, при котором фрагменты ДНК секвенируют
   с каждого конца навстречу друг другу);
   - Включены [проверка и восстановление парности прочтений](/settings/settings/alignment-settings#disable-repair)
   и/или количество прочтений в парных файлах образца не совпадает.

Проверка и восстановление парности прочтений
производится [BBMap Repair](https://github.com/BioInfoTools/BBMap/blob/master/sh/repair.sh).
В ходе выполнения задачи происходит следующее:
   - Сортировка строк в файлах.
   - Восстановление порядка в парных файлах: первое прочтение в первом файле должно соответствовать
   первому прочтению во втором файле и т.д. Порядок восстанавливается за счёт анализа названий прочтений,
   которые должны быть либо в формате Illumina (идентичный префикс, сопровождаемый "1:" и "2:" или "/1" и "/2"),
   либо полностью идентичны для обоих прочтений в паре.
   - Восстановление парности прочтений, необходимое для выравнивания, чтобы каждое прочтение из одного
файла содержало пару во втором. При очистке прочтений парность может быть нарушена, что приводит
к образованию синглтонов - прочтений, которые лишились пары в парном файле. По умолчанию синглтоны
удаляются из анализа, но их можно оставить в анализе для выравнивания на геном, если включить
[соответствующий параметр](/settings/settings/alignment-settings#use-singleton-reads).

2. **Выравнивание** - определение местоположения прочтений образца на референсном геноме версии hg38.
По умолчанию выравнивание производится с помощью рекомендуемого сообществом
инструмента [BWA2 Burrows-Wheeler Aligner](https://github.com/bwa-mem2/bwa-mem2) (BWA-MEM2) -
новейшей и более быстрой версии алгоритма BWA-MEM, который основан на обратном поиске с преобразованием
Берроуза-Уилера (BWT) и эффективно и быстро выравнивает короткие прочтения секвенирования на геном человека,
допуская мисмэтчи и гэпы[^1]. Этот выравниватель
можно [поменять в параметрах](/settings/settings/alignment-settings#change-alignment-tool)
на *BWA Burrows-Wheeler Aligner* - более раннюю версию алгоритма BWA-MEM[^2], *Bowtie2*[^3], *HISAT2*[^4]
или *STAR*[^5]. Выравнивание записывается в файл в формате SAM (текстовый файл для хранения биологических
последовательностей, выровненных на референсную последовательность).

После выравнивания картированные прочтения сортируются по крайним левым координатам с
помощью [samtools sort](http://www.htslib.org/doc/samtools-sort.html) и записываются в файл в
формате BAM (бинарный эквивалент формата SAM; занимает меньше места и позволяет быстрее работать с информацией,
чем SAM). Получившийся файл можно скачать в разделе "*Файлы с результатами*" в деталях задачи "*Выравнивание*"
("*Скачать BAM*"). Полученный BAM файл индексируется с
помощью [samtools index](http://www.htslib.org/doc/samtools-index.html).
Получившийся индексный файл можно скачать в том же разделе ("*Скачать BAI*").

В разделе "*Метрики*" в деталях задачи "*Выравнивание*" приведены метрики оценки качества выравнивания:

<p align="center">
<img src={require('/img/rus/alignment_metrics.png').default} width="900"/>
</p>

Для каждой метрики приведены:
- название метрики;
- описание результата проверки соответствия определенного показателя выравнивания образца и порога этой метрики:
приведены значение показателя для образца (например, доля картированных прочтений в файле выравнивания - Mapped
reads) и использованный порог метрики, при котором файл выравнивания считается качественным (можно поменять
в [параметрах](/settings/settings/alignment-settings#change-metric-thresholds));
- результат оценки качества выравнивания
по метрике: <img src={require('/img/rus/passed_metric.png').default} width="90"/>, если выравнивание образца
удовлетворяет порогу метрики, <br></br>или <img src={require('/img/rus/failed_metric.png').default} width="80"/>,
если не удовлетворяет.

#### Метрики оценки качества выравнивания {#alignment-metrics}

<table>
  <tr>
   <td>Метрика</td>
   <td>Значение порога метрики, при котором файл выравнивания считается качественным (значение по умолчанию, может
   быть изменено в <a href="/settings/settings/alignment-settings#change-metric-thresholds">параметрах</a>)</td>
  </tr>
  <tr>
   <td><b>Mapped reads</b> (картированные прочтения)</td>
   <td>В файле выравнивания не менее 85% картированных прочтений.</td>
  </tr>
  <tr>
   <td><b>Multiple alignments</b> (множественные выравнивания)</td>
   <td>В файле выравнивания не более 15% множественных выравниваний одного и тоже прочтения на геном.</td>
  </tr>
  <tr>
   <td><b>Forward/reverse balance</b> (равновесие прочтений с прямой и обратной цепи)</td>
   <td>Разница в количестве прочтений с прямой цепи и прочтений с обратной цепи не более 10% в файле выравнивания.</td>
  </tr>
  <tr>
   <td><b>Paired mapped reads</b> (картированные парные прочтения)</td>
   <td>В файле выравнивания не менее 80% картированных парных прочтений.</td>
  </tr>
  <tr>
   <td><b>Paired properly mapped reads</b> (правильно картированные парные прочтения)</td>
   <td>В файле выравнивания не менее 75% правильно картированных парных прочтений.</td>
  </tr>
  <tr>
   <td><b>Coverage per nucleotide</b> (понуклеотидное покрытие)</td>
   <td>Минимально допустимое понуклеотидное покрытие на геноме - 0.1.</td>
  </tr>
</table>

Если значение метрики в файле выравнивания образца не удовлетворяет установленному порогу,
то файл отмечается как не удовлетворяющий требованиям метрики, т.е. выравнивание завершается успешно,
а в статусе стадии указывается количество метрик, которые не соответствуют критериям.
Если же никакие прочтения образца не выровнялись на геном, то стадия "Выравнивание" завершается с ошибкой
и анализ останавливается.

Если в анализ образца включена
стадия [выявления вариации числа копий](/settings/settings/variant-discovery-settings#cnv-discovery), то
после успешного выполнения задачи "Выравнивание" анализ
продолжается [вычислением покрытия](/results/workflow-details/fastq-analysis/calculate-coverage) и
[выявлением вариации числа копий](/results/workflow-details/fastq-analysis/cnv-discovery).

[^1]: [Vasimuddin M., Sanchit M., Heng L., Srinivas A. Efficient Architecture-Aware Acceleration of BWA-MEM for Multicore Systems. IEEE Parallel and Distributed Processing Symposium (IPDPS) (2019)](https://doi.org/10.1109/IPDPS.2019.00041)
[^2]: [Li H. Aligning sequence reads, clone sequences and assembly contigs with BWA-MEM. arXiv:1303.3997v2 (2013)](https://doi.org/10.48550/arXiv.1303.3997)
[^3]: [Langmead B., Salzberg S. Fast gapped-read alignment with Bowtie 2. Nature Methods 9, 357:359 (2012)](https://doi.org/10.1038/nmeth.1923)
[^4]: [Kim D., Paggi J.M., Park C. et al. Graph-based genome alignment and genotyping with HISAT2 and HISAT-genotype. Nat Biotechnol 37, 907:915 (2019)](https://doi.org/10.1038/s41587-019-0201-4)
[^5]: [Dobin A., Davis C.A., Schlesinger F. et al. STAR: ultrafast universal RNA-seq aligner. Bioinformatics 29(1), 15:21 (2013)](https://doi.org/10.1093/bioinformatics/bts635)
