---
sidebar_position: 3
sidebar_label: Проверка качества и очистка
---

# Проверка качества и очистка

Контроль качества - важный шаг в анализе данных секвенирования. Он запускается после успешного выполнения
стадии ["Загрузка, идентификация и проверка"](/results/workflow-details/fastq-analysis/upload-identify-verify).
Сначала прочтения в файле (файлах) образца проходят проверку на соответствие критериям качества.
Затем, если в анализ образца включён [контроль качества](/settings/settings/quality-control-settings),
а образец не удовлетворяет критериям качества, для него запускается очистка.
Очистка может включать фильтрацию прочтений, которые не удовлетворяют критериям
качества, и/или обрезку последовательностей адаптеров, праймеров, поли(А)-хвостов и других типов
нежелательных последовательностей из прочтений.
Очистка прочтений может значительно улучшить качество картирования и поиска вариантов.

В случае образца секвенирования одиночных прочтений контроль качества запустится только для одного файла
и соответствующая стадия анализа будет называться "Проверка качества и очистка".
В случае образца секвенирования парных прочтений контроль качества запустится для двух парных файлов и
соответствующих стадий анализа будет две: "Проверка качества и очистка первичного файла" и
"Проверка качества и очистка парного файла".

<p align="center">
<img src={require('/img/rus/20-quality-control-report.png').default} width="1000"/>
</p>

Стадия анализа образца "Проверка качества и очистка" может включать следующие задачи:
1. **Проверка качества** прочтений в файле (файлах) образца с помощью [Falco](https://github.com/VCCRI/Falco/),
который работает в среднем в три раза быстрее, чем эквивалентный инструмент FastQC[^1].
В ходе выполнения задачи также определяется формат качества в файле образца.
Формат качества записывается в виде Q+число, например "Q33", где Q - Phred quality score, мера качества
идентификации нуклеотида в процессе автоматического секвенирования, а 33 - величина смещения по таблице
ASCII с символами, которые используются для записи Q. Формат Q33 является более новым и используется
Sanger и Illumina 1.8, а формат Q64 - более старый и используется ранними Illumina.

Подробный отчёт с визуализированными результатами проверки качества прочтений образца по
каждой метрике контроля качества можно открыть в разделе "*Файлы с результатами*" в
деталях задачи "*Проверка качества*" ("*Открыть Quality Report HTML*").
Там же можно скачать тот же отчёт, но в текстовом виде ("*Скачать Quality Report Data TXT*").
Ниже, в разделе "*Метрики*" в деталях задачи "*Проверка качества*" приведены результаты для
каждой метрики контроля качества:

<p align="center">
<img src={require('/img/rus/qc_metrics.png').default} width="900"/>
</p>

Для каждой метрики приведены:
- название метрики;
- описание результата проверки соответствия определенного показателя прочтений образца и порога этой метрики:
приведены значение показателя для образца (например, общее количество последовательностей в файле - Total
sequences) и использованный порог метрики, при котором прочтения в образце считаются качественными (можно поменять
в [параметрах](/settings/settings/quality-control-settings#qc-metrics));
- результат проверки качества по метрике: <img src={require('/img/rus/passed_metric.png').default} width="90"/>,
если образец удовлетворяет
порогу метрики, <br></br>или <img src={require('/img/rus/failed_metric.png').default} width="80"/>,
если образец не удовлетворяет порогу метрики.

#### Метрики контроля качества прочтений {#qc-metrics}

<table>
  <tr>
   <td>Метрика</td>
   <td>Значение порога метрики, при котором прочтения в образце считаются качественными (значение по умолчанию, может
   быть изменено в <a href="/settings/settings/quality-control-settings#change-metric-thresholds">параметрах</a>)</td>
   <td>Последствия, если образец не удовлетворяет порогу метрики</td>
  </tr>
  <tr>
   <td><b>Total sequences</b> (всего последовательностей)</td>
   <td>Минимальное количество прочтений в файле - 10,000.</td>
   <td>Анализ образца прерывается.</td>
  </tr>
  <tr>
   <td><b>Length distribution</b> (распределение длин прочтений)</td>
   <td>Файл содержит не более 25% коротких прочтений (прочтения длиной ≤ 20 п.н.).</td>
   <td>Задача "Обрезка по качеству": фильтрация коротких прочтений.</td>
  </tr>
  <tr>
   <td><b>Tiles sequence quality</b> (Качество по плиткам)</td>
   <td>Файл содержит не более 10 проточных ячеек с плитками низкого качества (максимально допустимое отклонение
   качества прочтений, поступающих из конкретных плиток проточных ячеек, от среднего качества по всем плиткам в
   файле - 7).</td>
   <td>Задача "Фильтрация по Tile-плитке": плитки, из которых поступили прочтения низкого качества,
   исключаются из анализа.</td>
  </tr>
  <tr>
   <td><b>First base sequence quality</b> (качество прочтения начальных нуклеотидов последовательности)</td>
   <td>Качество идентификации трёх начальных нуклеотидов в прочтении не менее 20.</td>
   <td>Задача "Фильтрация по качеству": фильтрация прочтений с низким качеством.</td>
  </tr>
  <tr>
   <td><b>Middle base sequence quality</b> (качество прочтения средних нуклеотидов последовательности)</td>
   <td>Качество идентификации средних нуклеотидов в прочтении не менее 20.</td>
   <td>Задача "Обрезка по качеству" или "Фильтрация по качеству".</td>
  </tr>
  <tr>
   <td><b>Last base sequence quality</b> (качество прочтения конечных нуклеотидов последовательности)</td>
   <td>Качество идентификации трёх конечных нуклеотидов в прочтении не менее 20.</td>
   <td>Задача "Обрезка по качеству".</td>
  </tr>
  <tr>
   <td><b>Overrepresented sequences</b> (перепредставленные последовательности)</td>
   <td>Файл содержит не более 1% перепредставленных последовательностей (последовательности, которые составляют
   более 0,1% от общего числа последовательностей).</td>
   <td>Файл отмечается как не удовлетворяющий требованиям метрики.</td>
  </tr>
  <tr>
   <td><b>Adapter contaminated</b> (загрязнение адаптерами)</td>
   <td>Файл содержит не более 1% прочтений, контаминированных адаптерными последовательностями.</td>
   <td>Задача "Обрезка по качеству": удаление адаптеров.</td>
  </tr>
  <tr>
   <td><b>Base N content</b> (содержание N)</td>
   <td>Среди всех нуклеотидов в файле есть не более 20% нераспознанных нуклеотидов N.</td>
   <td>Файл отмечается как не удовлетворяющий требованиям метрики.</td>
  </tr>
  <tr>
   <td><b>GC content</b> (содержание GC)</td>
   <td>Максимальный порог наклона пика содержания пары GC в файле - 0.035.
   Минимально допустимая длина волны (расстояние между двумя пиками GC) в файле - 4.</td>
   <td>Файл отмечается как не удовлетворяющий требованиям метрики.</td>
  </tr>
  <tr>
   <td><b>Base sequence content</b> (содержание основания в последовательности - соотношение AT/GC)</td>
   <td>Порог максимального значения разницы между спаренными основаниями A и T или G и C среди всех прочтений
   в файле - 20%. Порог разницы между спаренными основаниями A и T или G и C в файле - 1%.
   Порог среднего значения разницы между спаренными основаниями A и T или G и C в файле - 1%.</td>
   <td>Файл отмечается как не удовлетворяющий требованиям метрики.</td>
  </tr>
</table>

2. **Очистка**, если включён [контроль качества](/settings/settings/quality-control-settings):

   2.1. **Фильтрация по Tile-плитке**, если проточных ячеек с плитками низкого качества
   больше 10 (максимально допустимое отклонение качества прочтений, поступающих из конкретных
   плиток проточных ячеек, от среднего качества по всем плиткам в файле - 7).
   В ходе фильтрации плитки, из которых поступили прочтения, превышающие максимально допустимое
   отклонение качества прочтений, исключаются из анализа с помощью
   [BBMap FilterByTile](https://github.com/abiswas-odu/Disco/blob/master/bbmap/docs/guides/FilterByTileGuide.txt).
   После фильтрации по Tile-плитке снова проводится проверка качества.

   2.2. **Обрезка по качеству**:
      - Удаление адаптеров, если файл образца содержит более 1% прочтений, контаминированных
      адаптернымии последовательностями.
      - Фильтрация коротких прочтений, если файл образца содержит более 25% коротких прочтений (прочтения,
      длина которых меньше минимальной длины (20 п.н.)).
      - Обрезка по качеству, если качество идентификации трёх конечных нуклеотидов в прочтении
      ниже порога качества (20).

   Производится с помощью [Cutadapt](https://cutadapt.readthedocs.io/en/stable/).
   После задачи обрезки по качеству снова проводится проверка качества, и, если образец всё ещё
   не удовлетворяет критериям качества, то цикл "обрезка по качеству - проверка качества" итеративно
   повторяется с различными значениями параметров (порог качества и минимальная длина) до тех пор, пока
   образец не станет удовлетворять критериям качества.

   2.3. **Построение образца**: если для образца требуется провести обрезку по качеству, но образец
   содержит более 600 тысяч прочтений, то для него сначала строится пробная выборка, состоящая из
   каждого n-ного прочтения образца, где n - частота семплирования (указана в параметрах задачи).
   Скачать файл построенного образца можно в разделе "*Файлы с результатами*" в
   деталях задачи "*Построение образца*" ("*Скачать FASTQ_GZ*").
   Построенный образец проходит проверку качества, а затем для него итеративно повторяется цикл
   "обрезка по качеству - проверка качества" с различными значениями параметров (порог качества и
   минимальная длина) до тех пор, пока образец не станет удовлетворять критериям качества.
   После этого очистка по качеству и последующая проверка качества запускаются уже для исходного файла
   образца с теми параметрами, которые были вычислены для пробной выборки.

   2.4. **Фильтрация по качеству**: если качество идентификации трёх начальных нуклеотидов в прочтении
   ниже порога качества (20), производится фильтрация прочтений с низким качеством с помощью
   [FASTX-Toolkit Quality Filter](http://hannonlab.cshl.edu/fastx_toolkit/commandline.html#fastq_quality_filter_usage).
   После фильтрации снова проводится проверка качества, и если образец всё ещё не удовлетворяет критериям
   качества, то цикл "фильтрация по качеству - проверка качества" итеративно повторяется с различными значениями
   параметров (минимальный показатель качества для сохранения (q) и минимальный процент оснований, которые должны
   иметь качество q) до тех пор, пока образец не станет удовлетворять критериям качества.

Задачи из итерационных циклов обрезки и фильтрации по качеству, параметры которых не подошли для
получения результатов, удовлетворяющих критериям качества, а также задача "Построение образца"
имеют статус <img src={require('/img/rus/canceled_status.png').default} width="100"/>, так как они
непосредственно не связаны с анализом образца.

Скачать файл образца после очистки можно в разделе "*Файлы с результатами*" в
деталях той задачи очистки ("*Фильтрация по Tile-плитке*", "*Обрезка по качеству*"
или "*Фильтрация по качеству*"), которая была выполнена последней ("*Скачать FASTQ_GZ*").

Если в анализ образца [включено выравнивание](/settings/settings/alignment-settings), то после успешного
выполнения стадии "Проверка качества и очистка"
начнётся [стадия "Выравнивание"](/results/workflow-details/fastq-analysis/alignment).

[^1]: [de Sena Brandine G. and Smith A.D. Falco: high-speed FastQC emulation for quality control of sequencing data. F1000Research 2021, 8:1874 (2021)](https://doi.org/10.12688/f1000research.21142.2)
